#ansible-playbook -i ",localhost" -c local -e@/edx/app/edx_ansible/server-vars.yml /edx/app/edx_ansible/edx_ansible/playbooks/edx-programs.yml
---
- hosts: localhost
  become: true
  gather_facts: True
  pre_tasks:
    - name: Update repositories cache and install packages
      apt:
        name: "{{ item }}"
        update_cache: yes
      with_items:
        - python-pip
        - libffi-dev
        - gcc
        - g++
        - build-essential
  roles:
    - role: nginx
      nginx_sites:
      - programs
    - programs
  post_tasks:
    - name: Create static css dir
      file:
        path: "{{ PROGRAMS_DATA_DIR }}/staticfiles/css"
        state: directory
      become_method: sudo
      become_user: programs
      become: True

    - name: compile sass
      shell: >
        chdir={{ programs_code_dir }}
        {{ programs_venv_dir }}/bin/sassc {{ PROGRAMS_DATA_DIR }}/staticfiles/sass/main-ltr.scss {{ PROGRAMS_DATA_DIR }}/staticfiles/css/main-ltr.css
      become_user: "{{ programs_user }}"
      when: not devstack

    - name: restart the application
      supervisorctl:
        state: restarted
        supervisorctl_path: "{{ supervisor_ctl }}"
        config: "{{ supervisor_cfg }}"
        name: "{{ programs_service_name }}"
      when: not disable_edx_services
      become_user: "{{ supervisor_service_user }}"
